name: SeedSphere CI

on:
  push:
    branches: [ main ]
    paths:
      - 'router/**'
      - 'bridge/**'
      - '.github/workflows/ci.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'router/**'
      - 'bridge/**'
      - '.github/workflows/ci.yml'

jobs:
  router-ci:
    name: Router CI (Dart)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: router
    
    steps:
      - uses: actions/checkout@v4
      
      - uses: dart-lang/setup-dart@v1
      
      - name: Cache Pub Packages
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-dart-${{ hashFiles('router/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-dart-
            
      - name: Install Dependencies
        run: dart pub get
        
      - name: Analyze
        run: dart analyze --fatal-infos
        
      - name: Run Tests
        run: dart test

  bridge-ci:
    name: Bridge CI (TypeScript)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bridge
        
    steps:
      - uses: actions/checkout@v4
      
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
          cache-dependency-path: bridge/package-lock.json
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Typecheck & Build
        run: npm run build
