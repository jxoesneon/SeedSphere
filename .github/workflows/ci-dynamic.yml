name: Dynamic CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  analyze:
    runs-on: windows-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Matrix
        id: set-matrix
        shell: pwsh
        run: |
          $Matrix = ./.agent/scripts/ci_analyze.ps1 -BaseRef ${{ github.base_ref || 'HEAD~1' }}
          echo "matrix=$Matrix" >> $env:GITHUB_OUTPUT

  build:
    needs: analyze
    if: ${{ fromJson(needs.analyze.outputs.matrix).include[0] != null }} # Graceful null check
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.analyze.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Flutter
        if: matrix.project == 'gardener'
        uses: subosito/flutter-action@v2

      - name: Install Linux Dependencies
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y clang cmake ninja-build pkg-config libgtk-3-dev liblzma-dev libstdc++-12-dev libsecret-1-dev libsqlite3-dev libjsoncpp-dev libnm-dev

      - name: Setup Dart
        if: matrix.project == 'router'
        uses: dart-lang/setup-dart@v1

      - name: Setup Node
        if: matrix.project != 'gardener' && matrix.project != 'router'
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "npm"
          cache-dependency-path: ${{ matrix.project }}/package-lock.json

      - name: Run Tests
        env:
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET_DESKTOP }}
        run: |
          cd ${{ matrix.project }}
          flutter pub get || dart pub get
          ${{ matrix.cmd }}
